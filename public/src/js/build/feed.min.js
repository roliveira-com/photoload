var shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),sharedMomentsArea=document.querySelector("#shared-moments"),form=document.querySelector("form"),titleInput=document.querySelector("#title"),locationInput=document.querySelector("#location"),videoPlayer=document.querySelector("#player"),canvasElement=document.querySelector("#canvas"),captureButton=document.querySelector("#capture-btn"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image"),locationBtn=document.querySelector("#location-btn"),locationLoader=document.querySelector("#location-loader"),picture=void 0,fetchedLocation={rawLocationLat:null,rawLocationLon:null};function initLocation(){"geolocation"in navigator||(locationBtn.style.display="none")}function initMedia(){"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=function(e){var o=navigator.webkitGetUserMedia||navigator.mpzGetUserMedia;return o?new Promise(function(e,t){o.call(navigator,constrants,e,t)}):Promise.reject(new Error("getUserMedia não implementado"))}),navigator.mediaDevices.getUserMedia({video:!0}).then(function(e){videoPlayer.srcObject=e,videoPlayer.style.display="block"}).catch(function(e){imagePickerArea.style.display="block"})}function openCreatePostModal(){createPostArea.style.display="block",setTimeout(function(){createPostArea.style.transform="translateY(0)",captureButton.style.display="inline",initMedia(),initLocation()},1),deferredPrompt&&(deferredPrompt.prompt(),deferredPrompt.userChoice.then(function(e){console.log(e.outcome),"dismissed"===e.outcome?console.log("Instalação cancelada pelo usuário"):console.log("Instalação aceita pelo usuário")}),deferredPrompt=null)}function closeCreatePostModal(){setTimeout(function(){createPostArea.style.transform="translateY(100vh)"},1),videoPlayer.style.display="none",imagePickerArea.style.display="none",canvasElement.style.display="none",createPostArea.style.display="none",locationBtn.style.display="inline",videoPlayer.srcObject&&videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()})}function onSaveButtonClicked(e){console.log("Botão save clicado"),"caches"in window&&caches.open("photoload-user").then(function(e){e.add("https://httpbin.org/get"),e.add("/src/images/sf-boat.jpg")})}function clearCards(){for(;sharedMomentsArea.hasChildNodes();)sharedMomentsArea.removeChild(sharedMomentsArea.lastChild)}function createCard(e){var t=document.createElement("div");t.className="shared-moment-card mdl-card mdl-shadow--2dp",t.setAttribute("id",e.id);var o=document.createElement("div");o.className="mdl-card__title",o.style.color="white",o.style.backgroundImage='url("'+e.picture+'")',o.style.backgroundSize="cover",o.style.height="180px",t.appendChild(o);var a=document.createElement("h2");a.className="mdl-card__title-text",a.textContent=e.title,o.appendChild(a);var n=document.createElement("div");n.className="mdl-card__supporting-text",n.textContent=e.location,n.style.textAlign="center",t.appendChild(n),componentHandler.upgradeElement(t),sharedMomentsArea.appendChild(t)}function updateUI(e){clearCards();for(var t=0;t<e.length;t++)createCard(e[t])}locationBtn.addEventListener("click",function(e){"geolocation"in navigator&&(locationBtn.style.display="none",locationLoader.style.display="block",navigator.geolocation.getCurrentPosition(function(e){locationBtn.style.display="inline",locationLoader.style.display="none",fetchedLocation={rawLocationLat:e.coords.latitude,rawLocationLon:e.coords.longitude},locationInput.value="In Sao Paulo",document.querySelector("#manual-location").classList.add("is-focused")},function(e){console.log(e),locationBtn.style.display="inline",locationLoader.style.display="none",fetchedLocation={rawLocationLat:null,rawLocationLon:null}},{timeout:1e4}))}),captureButton.addEventListener("click",function(e){canvasElement.style.display="block",videoPlayer.style.display="none",captureButton.style.display="none",canvasElement.getContext("2d").drawImage(videoPlayer,0,0,canvas.width,videoPlayer.videoHeight/(videoPlayer.videoWidth/canvas.width)),videoPlayer.srcObject.getVideoTracks().forEach(function(e){console.log("track: ",e),e.stop()}),picture=dataURItoBlob(canvasElement.toDataURL())}),imagePicker.addEventListener("change",function(e){picture=e.target.files[0]}),shareImageButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal);var networkDataReceived=!1;function getData(){return fetch("https://photoload-98c58.firebaseio.com/posts.json").then(function(e){return e.json()}).then(function(e){networkDataReceived=!0,console.log("Dados da web",e);var t=[];for(var o in e)t.push(e[o]);t.reverse(),updateUI(t),bindCardDetailsListener()})}function sendData(){var e=(new Date).toISOString(),t=new FormData;t.append("id",e),t.append("title",titleInput.value),t.append("location",locationInput.value),t.append("file",picture,e+".png"),t.append("rawLocationLat",fetchedLocation.lat||locationInput.value),t.append("rawLocationLon",fetchedLocation.lon||locationInput.value),fetch("https://us-central1-photoload-98c58.cloudfunctions.net/storePostData",{method:"POST",body:t}).then(function(e){console.log("Dados enviados",e),updateUI()})}getData(),"indexedDB"in window&&readAllData("posts").then(function(e){networkDataReceived||(console.log("Dados do cache (IndexDB)",e),updateUI(e))}),form.addEventListener("submit",function(e){(e.preventDefault(),""!==titleInput.value.trim()&&""!==locationInput.value.trim())?(closeCreatePostModal(),(new Moments).new(titleInput.value,locationInput.value,picture,fetchedLocation.rawLocationLat,fetchedLocation.rawLocationLon)):alert("digite alguma coisa!")});